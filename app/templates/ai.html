{% extends "base.html" %}

{% block title %}AI 助手 - TaskFlow{% endblock %}
{% block page_title %}AI 智能助手{% endblock %}

{% block content %}
<div x-data="aiAssistant()" x-init="init()" class="space-y-6">
    
    <!-- AI Status -->
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div :class="status.ollama_running ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'" class="w-10 h-10 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900">AI 状态</h3>
                <p class="text-sm text-gray-500" x-text="status.ollama_running ? '本地模型运行中 (' + status.model + ')' : '使用规则引擎模式（本地模型未启动）'"></p>
            </div>
        </div>
        <button @click="checkStatus()" class="text-sm text-indigo-600 hover:text-indigo-800">刷新状态</button>
    </div>

    <!-- Feature Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Natural Language to Cron -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                自然语言转 Cron
            </h3>
            <p class="text-sm text-gray-500 mb-4">用日常语言描述时间，AI 自动转换为 Cron 表达式</p>
            
            <div class="space-y-3">
                <input x-model="cronInput" type="text" placeholder="例如：每天早上9点、每5分钟、每周一" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button @click="convertToCron()" :disabled="!cronInput || loading" 
                        class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                    <span x-show="!loading">转换</span>
                    <span x-show="loading">处理中...</span>
                </button>
            </div>

            <div x-show="cronResult" class="mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <code class="text-lg font-bold text-indigo-600" x-text="cronResult.cron"></code>
                    <span class="text-xs px-2 py-1 rounded-full" 
                          :class="cronResult.source === 'llm' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'"
                          x-text="cronResult.source === 'llm' ? 'AI解析' : '规则匹配'"></span>
                </div>
                <p class="text-sm text-gray-600 mb-2" x-text="cronResult.description"></p>
                <div x-show="cronResult.next_runs.length > 0" class="text-xs text-gray-500">
                    <p class="font-medium mb-1">下次执行时间：</p>
                    <ul class="space-y-1">
                        <template x-for="time in cronResult.next_runs.slice(0, 3)" :key="time">
                            <li x-text="time"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Task Config Suggestion -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                智能任务配置
            </h3>
            <p class="text-sm text-gray-500 mb-4">描述您的需求，AI 推荐最佳任务配置</p>
            
            <div class="space-y-3">
                <textarea x-model="configInput" rows="3" placeholder="例如：每天备份数据库到远程服务器" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                <button @click="suggestConfig()" :disabled="!configInput || loading" 
                        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:opacity-50">
                    获取建议
                </button>
            </div>

            <div x-show="configResult" class="mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 bg-indigo-100 text-indigo-600 rounded text-sm" x-text="configResult.task_type"></span>
                    <span class="font-medium text-gray-900" x-text="configResult.task_name"></span>
                </div>
                <p class="text-sm text-gray-600 mb-2">推荐 Cron: <code x-text="configResult.cron"></code></p>
                <div class="text-xs text-gray-500">
                    <p class="font-medium mb-1">配置提示：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <template x-for="tip in configResult.tips" :key="tip">
                            <li x-text="tip"></li>
                        </template>
                    </ul>
                </div>
                <button @click="applyConfig()" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 text-sm">
                    应用此配置创建任务
                </button>
            </div>
        </div>

        <!-- Error Analysis -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                错误智能分析
            </h3>
            <p class="text-sm text-gray-500 mb-4">粘贴错误信息，AI 分析原因并提供解决方案</p>
            
            <div class="space-y-3">
                <select x-model="errorTaskType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="http">HTTP 请求</option>
                    <option value="shell">Shell 命令</option>
                    <option value="python">Python 脚本</option>
                    <option value="backup">数据备份</option>
                </select>
                <textarea x-model="errorInput" rows="4" placeholder="粘贴错误信息..." 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                <button @click="analyzeError()" :disabled="!errorInput || loading" 
                        class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 disabled:opacity-50">
                    分析错误
                </button>
            </div>

            <div x-show="errorResult" class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs" x-text="errorResult.category"></span>
                    <span class="text-xs text-gray-500" x-text="errorResult.source === 'llm' ? 'AI分析' : '规则分析'"></span>
                </div>
                <p x-show="errorResult.root_cause" class="text-sm text-gray-700 mb-2" x-text="errorResult.root_cause"></p>
                <div class="text-sm">
                    <p class="font-medium text-gray-700 mb-1">解决方案：</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <template x-for="solution in errorResult.suggestions" :key="solution">
                            <li x-text="solution"></li>
                        </template>
                    </ul>
                </div>
                <p x-show="errorResult.prevention" class="mt-2 text-xs text-gray-500" x-text="'预防措施: ' + errorResult.prevention"></p>
            </div>
        </div>

        <!-- AI Chat -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                AI 对话助手
            </h3>
            <p class="text-sm text-gray-500 mb-4">有任何问题？直接问 AI 助手</p>
            
            <div class="h-64 overflow-y-auto bg-gray-50 rounded-lg p-4 mb-4 space-y-3" id="chat-messages">
                <template x-for="msg in chatMessages" :key="msg.id">
                    <div :class="msg.role === 'user' ? 'text-right' : 'text-left'">
                        <div :class="msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200'" 
                             class="inline-block px-4 py-2 rounded-lg max-w-xs text-sm whitespace-pre-line" x-text="msg.content"></div>
                    </div>
                </template>
            </div>

            <div class="flex space-x-2">
                <input x-model="chatInput" @keydown.enter="sendMessage()" type="text" placeholder="输入消息..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button @click="sendMessage()" :disabled="!chatInput || loading" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50">
                    发送
                </button>
            </div>
        </div>

    </div>
</div>

<script>
function aiAssistant() {
    return {
        status: { ollama_running: false, model: null, mode: 'rule_only' },
        loading: false,
        
        // Cron converter
        cronInput: '',
        cronResult: null,
        
        // Config suggestion
        configInput: '',
        configResult: null,
        
        // Error analysis
        errorInput: '',
        errorTaskType: 'shell',
        errorResult: null,
        
        // Chat
        chatInput: '',
        chatMessages: [{id: 1, role: 'assistant', content: '您好！我是 TaskFlow AI 助手。\n\n我可以帮您：\n• 转换自然语言为 Cron 表达式\n• 推荐任务配置\n• 分析任务错误\n• 解答使用问题\n\n请问需要什么帮助？'}],
        
        async init() {
            await this.checkStatus();
        },
        
        async checkStatus() {
            try {
                const response = await fetch('/api/ai/status');
                if (response.ok) {
                    this.status = await response.json();
                }
            } catch (error) {
                console.error('Failed to check status:', error);
            }
        },
        
        async convertToCron() {
            this.loading = true;
            try {
                const response = await fetch('/api/ai/natural-to-cron', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: this.cronInput })
                });
                if (response.ok) {
                    this.cronResult = await response.json();
                }
            } catch (error) {
                alert('转换失败: ' + error);
            }
            this.loading = false;
        },
        
        async suggestConfig() {
            this.loading = true;
            try {
                const response = await fetch('/api/ai/suggest-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: this.configInput })
                });
                if (response.ok) {
                    this.configResult = await response.json();
                }
            } catch (error) {
                alert('获取建议失败: ' + error);
            }
            this.loading = false;
        },
        
        applyConfig() {
            // Store config in localStorage and redirect to tasks page
            localStorage.setItem('ai_suggested_config', JSON.stringify(this.configResult));
            window.location.href = '/tasks';
        },
        
        async analyzeError() {
            this.loading = true;
            try {
                const response = await fetch('/api/ai/analyze-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        error_message: this.errorInput,
                        task_type: this.errorTaskType
                    })
                });
                if (response.ok) {
                    this.errorResult = await response.json();
                }
            } catch (error) {
                alert('分析失败: ' + error);
            }
            this.loading = false;
        },
        
        async sendMessage() {
            if (!this.chatInput.trim()) return;
            
            const userMsg = this.chatInput;
            this.chatMessages.push({id: Date.now(), role: 'user', content: userMsg});
            this.chatInput = '';
            this.loading = true;
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMsg })
                });
                if (response.ok) {
                    const result = await response.json();
                    this.chatMessages.push({id: Date.now() + 1, role: 'assistant', content: result.response});
                }
            } catch (error) {
                this.chatMessages.push({id: Date.now() + 1, role: 'assistant', content: '抱歉，处理失败，请重试。'});
            }
            
            this.loading = false;
            this.$nextTick(() => {
                const container = document.getElementById('chat-messages');
                container.scrollTop = container.scrollHeight;
            });
        }
    }
}
</script>
{% endblock %}
